<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prenota un Servizio ‚Äì CRI Guardistallo e Casale Marittimo</title>
    <!-- FAVICON & APP ICON -->
    <link rel="icon" type="image/png" sizes="32x32" href="img/favicon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="img/favicon.png">
    <link rel="apple-touch-icon" href="img/favicon.png">
    <meta name="theme-color" content="#c1121f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Bootstrap + Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <!-- Stili del sito -->
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <img src="img/logo-cri.svg" alt="Logo CRI" width="70" class="me-2">
                <span class="fw-bold text-danger">Croce Rossa Italiana<br><small class="text-dark">Comitato di
                        Guardistallo e Casale Marittimo ODV</small></span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span
                    class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto text-nowrap">
                    <li class="nav-item"><a class="nav-link" href="chi-siamo.html">Chi siamo</a></li>
                    <li class="nav-item"><a class="nav-link" href="attivita.html">Attivit√†</a></li>
                    <li class="nav-item"><a class="nav-link" href="diventa-volontario.html">Diventa Volontario</a></li>
                    <li class="nav-item"><a class="nav-link active" href="prenota-servizio.html">Prenota un Servizio</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="nostri-corsi.html">Corsi</a></li>
                    <li class="nav-item"><a class="nav-link" href="sostienici.html">Sostienici</a></li>
                    <li class="nav-item"><a class="nav-link" href="news.html">News</a></li>
                    <li class="nav-item"><a class="nav-link" href="contatti.html">Contatti</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container" style="margin-top:90px;">
        <header class="mb-3">
            <h1 class="mb-1">Prenota un Servizio</h1>
            <p class="text-muted">Compila il modulo per richiedere un servizio al Comitato.</p>
        </header>

        <div class="row g-4">
            <!-- COLONNA FORM -->
            <div class="col-lg-8">
                <div class="card card-soft">
                    <div class="card-body">
                        <!-- Titolo sezione -->
                        <div class="section-title mb-3">
                            <i class="fa-solid fa-user"></i>
                            <h2 class="h5 m-0">Dati richiedente</h2>
                        </div>

                        <!-- üîΩ IL TUO FORM (identico) -->
                        <!-- ‚úÖ Web3Forms -->
                        <form id="requestForm" class="needs-validation" action="https://api.web3forms.com/submit"
                            method="POST" novalidate>
                            <!-- Web3Forms hidden -->
                            <input type="hidden" name="access_key" value="9ec35eab-a386-44dc-ab35-6f4d77317715">
                            <input type="hidden" name="subject"
                                value="Richiesta servizio - CRI Guardistallo e Casale Marittimo">
                            <input type="hidden" name="from_name" value="Sito CRI Guardistallo e Casale Marittimo">
                            <!-- RIMOSSO: <input type="hidden" name="template" value="table"> -->
                            <input type="hidden" name="redirect" id="redirectUrl" value="">

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Nome e Cognome</label>
                                    <input type="text" name="nome" class="form-control" placeholder="Mario Rossi"
                                        required>
                                    <div class="invalid-feedback">Inserisci il tuo nome e cognome.</div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Telefono</label>
                                    <input type="tel" name="telefono" class="form-control" placeholder="333 1234567"
                                        pattern="^[0-9 +()\\-\\s]{6,}$" required>
                                    <div class="invalid-feedback">Inserisci un numero valido.</div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Email</label>
                                    <input type="email" name="email" class="form-control" placeholder="nome@email.it"
                                        required>
                                    <div class="invalid-feedback">Inserisci un'email valida.</div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Tipo di Servizio</label>
                                    <select name="servizio" id="servizioSelect" class="form-select" required>
                                        <option value="" selected disabled>Seleziona‚Ä¶</option>
                                        <option>Trasporto sanitario</option>
                                        <option>Cure mediche</option>
                                    </select>
                                    <div class="invalid-feedback">Seleziona un servizio.</div>
                                </div>

                                <div class="col-12">
                                    <hr class="my-3">
                                </div>
                                <div class="col-12">
                                    <div class="section-title mb-2">
                                        <i class="fa-solid fa-route"></i>
                                        <h3 class="h6 m-0">Logistica</h3>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Data richiesta</label>
                                    <input type="date" name="data" class="form-control" required>
                                    <div class="invalid-feedback">Scegli una data.</div>
                                </div>

                                <!-- ORARIO: solo per Trasporto sanitario -->
                                <div class="col-md-6 d-none" id="orarioField">
                                    <label class="form-label">Devo essere l√¨ alle:</label>
                                    <input type="time" name="orario" id="orarioInput" class="form-control" min="07:00"
                                        max="20:00">
                                    <div class="invalid-feedback">Seleziona un orario tra le 07:00 e le 20:00.</div>
                                </div>

                                <!-- ORA RITORNO (opz., solo per Trasporto sanitario) -->
                                <div class="col-md-6 d-none" id="oraRitornoField">
                                    <label class="form-label">Ora di ritorno (se nota)</label>
                                    <input type="time" name="ora_ritorno" id="oraRitornoInput" class="form-control"
                                        min="07:00" max="20:00">
                                </div>

                                <!-- DESTINAZIONE -->
                                <div class="col-12 d-none" id="luogoField">
                                    <label class="form-label">Luogo / Destinazione</label>
                                    <input type="text" id="luogoAutocomplete" class="form-control"
                                        placeholder="Digita ospedale, ambulatorio o indirizzo‚Ä¶">
                                    <div class="form-text">Suggerimenti da Google (Places).</div>
                                    <div class="invalid-feedback">Seleziona una destinazione valida.</div>
                                    <input type="hidden" id="luogoPlaceId">
                                    <input type="hidden" id="luogoLat">
                                    <input type="hidden" id="luogoLng">
                                    <input type="hidden" id="luogoMapsLink">
                                    <input type="hidden" id="luogoLinkNice">
                                    <input type="hidden" id="luogoComune">
                                </div>

                                <!-- PARTENZA -->
                                <div class="col-12 d-none" id="partenzaField">
                                    <label class="form-label">Indirizzo di partenza</label>
                                    <input type="text" id="partenzaAutocomplete" class="form-control"
                                        placeholder="Es: domicilio, RSA, ecc.">
                                    <div class="form-text">Puoi indicare domicilio o struttura di partenza.</div>
                                    <div class="invalid-feedback">Seleziona una partenza valida.</div>
                                    <input type="hidden" id="partenzaPlaceId">
                                    <input type="hidden" id="partenzaLat">
                                    <input type="hidden" id="partenzaLng">
                                    <input type="hidden" id="partenzaMapsLink">
                                    <input type="hidden" id="partenzaLinkNice">
                                    <input type="hidden" id="partenzaComune">
                                </div>

                                <div class="col-12">
                                    <hr class="my-3">
                                </div>
                                <div class="col-12">
                                    <div class="section-title mb-2">
                                        <i class="fa-solid fa-user-nurse"></i>
                                        <h3 class="h6 m-0">Stato di salute</h3>
                                    </div>
                                </div>

                                <!-- DEAMBULAZIONE -->
                                <div class="col-md-6">
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="nonDeambulaChk"
                                            name="non_deambula" value="Si">
                                        <label class="form-check-label" for="nonDeambulaChk">Non deambula</label>
                                    </div>
                                </div>
                                <div class="col-md-6 d-none" id="pesoField">
                                    <label class="form-label">Peso (opzionale)</label>
                                    <input type="number" step="0.1" min="20" max="250" name="peso" id="pesoInput"
                                        class="form-control" placeholder="kg">
                                </div>

                                <!-- SINTOMI -->
                                <div class="col-12">
                                    <label class="form-label d-block">Sintomi influenzali?</label>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="sintomi" id="sintomiNo"
                                            value="No" required>
                                        <label class="form-check-label" for="sintomiNo">No</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="sintomi" id="sintomiSi"
                                            value="Si" required>
                                        <label class="form-check-label" for="sintomiSi">S√¨</label>
                                    </div>
                                    <div class="invalid-feedback d-block">Indica se sono presenti sintomi.</div>
                                </div>

                                <div class="col-12 d-none" id="sintomiDettaglioField">
                                    <label class="form-label">Specifica i sintomi</label>
                                    <input type="text" name="sintomi_dettaglio" id="sintomiDettaglio"
                                        class="form-control" minlength="3" placeholder="Es. febbre, tosse‚Ä¶">
                                    <div class="invalid-feedback">Aggiungi un dettaglio dei sintomi.</div>
                                </div>

                                <!-- TS1 -->
                                <div class="col-12">
                                    <label class="form-label d-block">Richiesta TS1 (rimborso ASL)?</label>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="ts1" id="ts1No" value="No">
                                        <label class="form-check-label" for="ts1No">No</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="ts1" id="ts1Si" value="Si">
                                        <label class="form-check-label" for="ts1Si">S√¨</label>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <hr class="my-3">
                                </div>
                                <div class="col-12">
                                    <div class="section-title mb-2">
                                        <i class="fa-solid fa-comment-dots"></i>
                                        <h3 class="h6 m-0">Note</h3>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label class="form-label">Messaggio / Note</label>
                                    <textarea name="messaggio" class="form-control" rows="4"
                                        placeholder="Descrivi la richiesta‚Ä¶" required></textarea>
                                    <div class="invalid-feedback">Aggiungi un breve messaggio.</div>
                                </div>
                            </div>

                            <div class="d-flex align-items-center gap-3 mt-4">
                                <button type="submit" class="btn btn-danger btn-lg" id="submitBtn">Invia
                                    richiesta</button>
                                <div id="formStatus" class="text-success d-none">Richiesta inviata con successo ‚úÖ</div>
                                <div id="formError" class="text-danger d-none">Si √® verificato un errore. Riprova pi√π
                                    tardi.</div>
                            </div>

                            <p class="text-muted small mt-3 mb-0">
                                I dati saranno trattati ai soli fini della gestione della richiesta.
                            </p>
                        </form>
                    </div>
                </div>
            </div>

            <!-- COLONNA LATERALE -->
            <div class="col-lg-4">
                <div class="card card-soft mb-3">
                    <div class="card-body">
                        <div class="section-title"><i class="fa-solid fa-triangle-exclamation"></i>
                            <h3 class="h6 m-0">Emergenze</h3>
                        </div>
                        <p class="mb-2">In caso di emergenza <strong>chiama il 112</strong>.</p>
                        <span class="badge badge-soft rounded-pill">Questo modulo non gestisce urgenze</span>
                    </div>
                </div>
                <div class="card card-soft mb-3">
                    <div class="card-body">
                        <div class="section-title"><i class="fa-solid fa-circle-info"></i>
                            <h3 class="h6 m-0">Suggerimenti</h3>
                        </div>
                        <ul class="small mb-0">
                            <li>Per <strong>Trasporto sanitario</strong> indica <em>destinazione</em> e <em>orario</em>.
                            </li>
                            <li>Se <strong>non deambula</strong>, aggiungi il <em>peso</em> (aiuta a pianificare il
                                mezzo).</li>
                            <li>La <strong>TS1</strong> richiede verifica del medico (rimborso ASL).</li>
                        </ul>
                    </div>
                </div>
                <div class="card card-soft">
                    <div class="card-body">
                        <div class="section-title"><i class="fa-solid fa-shield-halved"></i>
                            <h3 class="h6 m-0">Privacy</h3>
                        </div>
                        <p class="help-hint mb-0">I dati saranno trattati secondo i principi CRI.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>


    <footer class="bg-light text-center text-muted py-4 mt-5">
        <div class="container">
            <p class="mb-1">&copy; 2025 Croce Rossa Italiana - Comitato di Guardistallo e Casale Marittimo</p>
            <p class="mb-0"><i class="fas fa-envelope"></i> info@criguardistallo.it | <i class="fas fa-phone"></i> +39
                000 000 0000</p>
        </div>
    </footer>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ============ Helpers GLOBALI ============
        function extractComune(components) {
            if (!components) return '';
            let comune = '', prov = '';
            components.forEach(c => {
                if (c.types.includes('locality') || c.types.includes('administrative_area_level_3'))
                    comune = c.long_name;
                if (c.types.includes('administrative_area_level_2'))
                    prov = c.short_name;
            });
            return comune ? `Comune: ${comune}${prov ? ' (' + prov + ')' : ''}` : '';
        }

        function applyPlace(place, out) {
            const lat = place.geometry?.location?.lat?.();
            const lng = place.geometry?.location?.lng?.();
            const label = place.name || place.formatted_address || '';

            out.input.value = label;
            if (out.placeId) out.placeId.value = place.place_id || '';
            if (out.lat) out.lat.value = lat ?? '';
            if (out.lng) out.lng.value = lng ?? '';
            if (out.comuneEl) out.comuneEl.value = extractComune(place.address_components);

            const url = (lat && lng) ? `https://www.google.com/maps/search/?api=1&query=${lat},${lng}` : '';
            if (out.mapsLink) out.mapsLink.value = url;
            if (out.linkNice) out.linkNice.value = url; // NOT HTML now (clean email)
        }

        // ============ Google callback ============
        function initAutocomplete() {
            const opts = {
                componentRestrictions: { country: ['it'] },
                fields: ['place_id', 'geometry', 'name', 'formatted_address', 'address_components'],
                types: ['geocode', 'establishment']
            };

            const luogoInput = document.getElementById('luogoAutocomplete');
            if (luogoInput) {
                const ac1 = new google.maps.places.Autocomplete(luogoInput, opts);
                ac1.addListener('place_changed', () => {
                    const p = ac1.getPlace(); if (!p || !p.place_id) return;
                    applyPlace(p, {
                        input: luogoInput,
                        placeId: document.getElementById('luogoPlaceId'),
                        lat: document.getElementById('luogoLat'),
                        lng: document.getElementById('luogoLng'),
                        mapsLink: document.getElementById('luogoMapsLink'),
                        linkNice: document.getElementById('luogoLinkNice'),
                        comuneEl: document.getElementById('luogoComune')
                    });
                });
            }

            const partenzaInput = document.getElementById('partenzaAutocomplete');
            if (partenzaInput) {
                const ac2 = new google.maps.places.Autocomplete(partenzaInput, opts);
                ac2.addListener('place_changed', () => {
                    const p = ac2.getPlace(); if (!p || !p.place_id) return;
                    applyPlace(p, {
                        input: partenzaInput,
                        placeId: document.getElementById('partenzaPlaceId'),
                        lat: document.getElementById('partenzaLat'),
                        lng: document.getElementById('partenzaLng'),
                        mapsLink: document.getElementById('partenzaMapsLink'),
                        linkNice: document.getElementById('partenzaLinkNice'),
                        comuneEl: document.getElementById('partenzaComune')
                    });
                });
            }
        }

        // ============ UX / Validazione ============
        document.addEventListener('DOMContentLoaded', () => {

            // Redirect + messaggio OK
            const redirectField = document.getElementById('redirectUrl');
            if (redirectField) {
                const u = new URL(window.location.href);
                u.searchParams.set('ok', '1');
                redirectField.value = u.toString();
            }
            const params = new URLSearchParams(window.location.search);
            if (params.get('ok') === '1') {
                document.getElementById('formStatus')?.classList.remove('d-none');
                document.getElementById('formError')?.classList.add('d-none');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            const form = document.getElementById('requestForm');

            const selectServizio = document.getElementById('servizioSelect');
            const orarioField = document.getElementById('orarioField');
            const orarioInput = document.getElementById('orarioInput');
            const oraRitornoField = document.getElementById('oraRitornoField');

            const luogoField = document.getElementById('luogoField');
            const luogoInput = document.getElementById('luogoAutocomplete');
            const luogoPlaceId = document.getElementById('luogoPlaceId');
            const luogoComune = document.getElementById('luogoComune');
            const luogoLink = document.getElementById('luogoLinkNice');

            const partenzaField = document.getElementById('partenzaField');
            const partenzaInput = document.getElementById('partenzaAutocomplete');
            const partenzaPlaceId = document.getElementById('partenzaPlaceId');
            const partenzaComune = document.getElementById('partenzaComune');
            const partenzaLink = document.getElementById('partenzaLinkNice');

            const nonDeambulaChk = document.getElementById('nonDeambulaChk');
            const pesoField = document.getElementById('pesoField');
            const pesoInput = document.getElementById('pesoInput');

            const sintomiSi = document.getElementById('sintomiSi');
            const sintomiNo = document.getElementById('sintomiNo');
            const sintomiDettaglioField = document.getElementById('sintomiDettaglioField');
            const sintomiDettaglio = document.getElementById('sintomiDettaglio');

            function toggleExtraFields() {
                const isTrasporto = selectServizio?.value === 'Trasporto sanitario';
                [orarioField, oraRitornoField, luogoField, partenzaField].forEach(el =>
                    isTrasporto ? el.classList.remove('d-none') : el.classList.add('d-none')
                );
                if (isTrasporto) {
                    orarioInput.setAttribute('required', 'required');
                    luogoInput.setAttribute('required', 'required');
                    partenzaInput.setAttribute('required', 'required');
                } else {
                    orarioInput.removeAttribute('required'); orarioInput.value = '';
                    luogoInput.removeAttribute('required'); luogoInput.value = '';
                    luogoPlaceId.value = luogoComune.value = luogoLink.value = '';
                    partenzaInput.removeAttribute('required'); partenzaInput.value = '';
                    partenzaPlaceId.value = partenzaComune.value = partenzaLink.value = '';
                    pesoField.classList.add('d-none');
                    pesoInput.value = '';
                }
            }
            selectServizio?.addEventListener('change', toggleExtraFields);
            toggleExtraFields();

            nonDeambulaChk?.addEventListener('change', () => {
                if (nonDeambulaChk.checked) {
                    pesoField.classList.remove('d-none');
                } else {
                    pesoField.classList.add('d-none');
                    pesoInput.value = '';
                }
            });

            [sintomiSi, sintomiNo].forEach(r => r?.addEventListener('change', () => {
                if (sintomiSi.checked) {
                    sintomiDettaglioField.classList.remove('d-none');
                    sintomiDettaglio.setAttribute('required', 'required');
                } else {
                    sintomiDettaglioField.classList.add('d-none');
                    sintomiDettaglio.removeAttribute('required');
                    sintomiDettaglio.value = '';
                }
            }));

            // *** EMAIL CLEANUP + INSERIMENTO ORDINATO DESTINAZIONE/PARTENZA ***
            form?.addEventListener('submit', (e) => {
                form.classList.add('was-validated');

                const isTrasporto = selectServizio?.value === 'Trasporto sanitario';
                if (isTrasporto) {
                    document.getElementById('orarioInput')?.setAttribute('required', 'required');
                    document.getElementById('partenzaAutocomplete')?.setAttribute('required', 'required');
                    luogoInput?.setAttribute('required', 'required');
                }

                // Normalizza Non deambula
                if (!nonDeambulaChk.checked) {
                    let hidden = document.getElementById('nonDeambulaHidden');
                    if (!hidden) {
                        hidden = document.createElement('input');
                        hidden.type = 'hidden';
                        hidden.id = 'nonDeambulaHidden';
                        hidden.name = 'non_deambula';
                        hidden.value = 'No';
                        form.appendChild(hidden);
                    }
                }

                // Inserisco DESTINAZIONE/PARTENZA nella posizione corretta
                const afterNode = document.querySelector('select[name="servizio"]'); // dopo servizio
                const insertAfter = (ref, node) => ref.parentNode.insertBefore(node, ref.nextSibling);

                // Rimuovo eventuali versioni precedenti
                form.querySelectorAll('input[name="DESTINAZIONE"], input[name="PARTENZA"]').forEach(el => el.remove());

                const dest = `üìç DESTINAZIONE\n${luogoInput.value}\n${luogoComune.value}\nMappa: ${luogoLink.value}`;
                const part = `üìç PARTENZA\n${partenzaInput.value}\n${partenzaComune.value}\nMappa: ${partenzaLink.value}`;

                const destField = document.createElement('input');
                destField.type = 'hidden';
                destField.name = 'DESTINAZIONE';
                destField.value = dest;

                const partField = document.createElement('input');
                partField.type = 'hidden';
                partField.name = 'PARTENZA';
                partField.value = part;

                insertAfter(afterNode, destField);
                insertAfter(destField, partField);

                if (!form.checkValidity()) { e.preventDefault(); e.stopPropagation(); }
            });
        });
    </script>



    <!-- Google Maps JS (Places) ‚Äì tua API key -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA_PAQxj6SvMzZGXccDLStY-hWd-Auzs4E&libraries=places&callback=initAutocomplete"></script>
</body>

</html>